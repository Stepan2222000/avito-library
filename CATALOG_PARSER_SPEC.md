# Спецификация: Парсер каталога Avito (v2)

## Суть идеи

Парсер каталога работает по принципу "продолжаемой операции". Внешний код открывает страницу каталога, вызывает парсер, получает результат. Если произошла критическая ошибка (проблема с прокси) — парсер возвращает частичные данные и информацию для продолжения. Внешний код создаёт новую страницу с новым прокси и продолжает парсинг с того места, где остановились.

---

## Ключевые принципы

1. **Страница уже открыта** — при вызове парсера страница уже находится на каталоге, парсер не делает лишний goto.

2. **Два уровня API** — есть функция для парсинга одной страницы (`parse_single_page`) и функция для парсинга всех страниц (`parse_catalog`). Можно использовать любую.

3. **Накопление данных** — карточки собираются страница за страницей и хранятся в объекте результата.

4. **Критические ошибки возвращают управление** — при блокировке прокси (403/407), таймауте или нераспознанном состоянии парсер останавливается и возвращает то, что успел собрать, плюс информацию для продолжения.

5. **Некритические ошибки решаются внутри** — капча, кнопка "Продолжить", rate-limit (429) обрабатываются внутри парсера без участия внешнего кода.

6. **Продолжение через метод** — объект результата имеет метод `continue_from(new_page)`, который принимает новую страницу и продолжает парсинг.

7. **Нет глобального состояния** — всё состояние хранится в объекте результата, можно запускать несколько парсеров параллельно.

---

## Две функции парсинга

### parse_single_page — парсинг одной страницы

Парсит одну страницу каталога. Страница уже должна быть открыта.

**Что делает:**
1. Вызывает `detect_page_state()` для определения состояния страницы
2. Если капча/429/кнопка — решает внутри через `resolve_captcha_flow()`
3. Если критическая ошибка (403/407/not_detected) — возвращает соответствующий статус
4. Если каталог — парсит все карточки на странице
5. Определяет есть ли следующая страница и её URL

**Что возвращает (SinglePageResult):**
- status — статус выполнения (SUCCESS, CAPTCHA_FAILED, PROXY_BLOCKED, и т.д.)
- cards — список карточек с этой страницы (если успех)
- has_next — есть ли следующая страница
- next_url — URL следующей страницы (если есть)
- error_state — какой детектор сработал (при ошибке)
- error_url — URL страницы (при ошибке)

**Не делает:**
- Не делает goto (страница уже открыта)
- Не накапливает данные между вызовами
- Не имеет continue_from

### parse_catalog — парсинг всех страниц

Парсит все страницы каталога с пагинацией. Внутри вызывает `parse_single_page` в цикле.

**Что делает:**
1. Вызывает `parse_single_page` для текущей страницы
2. Если успех — накапливает карточки, делает goto на следующую страницу
3. При goto делает retry (до 5 попыток) при таймауте
4. Повторяет пока не достигнут max_pages или не кончились страницы
5. При критической ошибке — возвращает результат с возможностью продолжения

**Что возвращает (CatalogParseResult):**
- status — статус выполнения
- listings — все собранные карточки (со всех страниц)
- meta — метаинформация (сколько страниц, сколько карточек)
- error_state, error_url — информация об ошибке
- resume_url, resume_page_number — информация для продолжения
- continue_from() — метод для продолжения после ошибки

**Параметры:**
- page — Playwright Page (уже открыта на каталоге)
- catalog_url — URL каталога (для навигации)
- fields — какие поля извлекать из карточек
- max_pages — максимум страниц (None = без лимита)
- sort — сортировка (date, price_asc, price_desc, mileage_asc)
- start_page — с какой страницы начинать
- max_captcha_attempts — лимит попыток капчи (по умолчанию 30)
- load_timeout — таймаут загрузки страницы (по умолчанию 3 минуты)
- load_retries — количество retry при таймауте (по умолчанию 5)

---

## Классификация состояний страницы

### Состояния, при которых парсим (успех)

- **Каталог** (`catalog_page_detector`) — парсим карточки, переходим на следующую страницу.

### Состояния, которые решаем внутри

- **Капча Geetest** (`captcha_geetest_detector`) — вызываем решатель капчи, после успеха проверяем состояние заново.

- **Rate-limit 429** (`proxy_block_429_detector`) — это тоже капча, решаем так же.

- **Кнопка "Продолжить"** (`continue_button_detector`) — вызываем `resolve_captcha_flow()`, он сам обработает кнопку.

### Критические ошибки (возвращаем управление)

- **Блокировка IP 403** (`proxy_block_403_detector`) — прокси заблокирован, нужна новая страница с новым прокси.

- **Auth 407** (`proxy_auth_407_detector`) — проблема с авторизацией прокси, нужна новая страница.

- **Не распознано** (`not_detected`) — ни один детектор не сработал, что-то пошло не так, нужна новая страница.

- **Таймаут загрузки** — страница не загрузилась за отведённое время, нужна новая страница.

- **Капча не решена** — после N попыток капча всё ещё не решена, возвращаем управление (возможно нужен другой прокси).

### Ошибки (неправильная страница)

- **Карточка товара** (`card_found_detector`) — это не каталог, а отдельное объявление. Ошибка в логике вызывающего кода.

- **Профиль продавца** (`seller_profile_detector`) — это не каталог. Ошибка.

- **Удалённое объявление** (`removed_or_not_found_detector`) — это не каталог. Ошибка.

---

## Flow работы парсера

### Flow parse_single_page (одна страница)

1. Страница уже открыта (внешний код сделал goto).

2. Вызываем `detect_page_state()`.

3. Обработка состояния:
   - Каталог → парсим карточки, ищем next_url, возвращаем SUCCESS
   - Капча/429/кнопка → вызываем `resolve_captcha_flow()`, после успеха снова detect
   - 403/407/not_detected → возвращаем соответствующий статус
   - Карточка/профиль/удалённое → возвращаем WRONG_PAGE
   - Капча не решена после всех попыток → возвращаем CAPTCHA_FAILED

4. Если каталог — парсим все карточки через `load_catalog_cards()` и `extract_listing()`.

5. Ищем ссылку на следующую страницу через `get_next_page_url()`.

6. Возвращаем SinglePageResult с карточками, has_next, next_url.

### Flow parse_catalog (все страницы)

1. Страница уже открыта на каталоге (внешний код сделал goto).

2. Вызываем `parse_single_page()` для текущей страницы.

3. Если успех — накапливаем карточки, увеличиваем счётчик страниц.

4. Если ошибка — возвращаем CatalogParseResult с накопленными данными и информацией для продолжения.

5. Проверяем лимит max_pages — если достигнут, возвращаем SUCCESS.

6. Если есть следующая страница — делаем goto с retry (до 5 попыток при таймауте).

7. Если goto успешен — повторяем с шага 2.

8. Если все retry исчерпаны — возвращаем LOAD_TIMEOUT.

9. Если следующей страницы нет — возвращаем SUCCESS.

### Flow continue_from (продолжение после ошибки)

1. Внешний код получил результат с `needs_new_page = True`.

2. Внешний код блокирует старый прокси (если 403/407), создаёт новую страницу с новым прокси.

3. Внешний код вызывает `result.continue_from(new_page)`.

4. Парсер определяет, нужен ли goto:
   - Если `skip_navigation=True` — не делаем goto (внешний код уже перешёл)
   - Если `skip_navigation=False` — делаем goto на resume_url
   - Если `skip_navigation=None` — detect, если каталог — не goto, иначе goto

5. Продолжаем парсинг с того места где остановились.

6. Все ранее собранные карточки сохраняются, новые добавляются к ним.

7. Счётчик страниц продолжается с предыдущего значения.

---

## Что возвращают функции

### SinglePageResult (от parse_single_page)

**При успехе:**
- status: SUCCESS
- cards: список карточек с этой страницы
- has_next: есть ли следующая страница
- next_url: URL следующей страницы

**При ошибке:**
- status: PROXY_BLOCKED / PROXY_AUTH_REQUIRED / PAGE_NOT_DETECTED / CAPTCHA_FAILED / WRONG_PAGE
- cards: пустой список
- error_state: какой детектор сработал
- error_url: URL страницы

### CatalogParseResult (от parse_catalog)

**При успехе:**
- status: SUCCESS или EMPTY
- listings: все собранные карточки (со всех страниц)
- meta: метаинформация (processed_pages, processed_cards)

**При критической ошибке:**
- status: PROXY_BLOCKED / PROXY_AUTH_REQUIRED / PAGE_NOT_DETECTED / LOAD_TIMEOUT / CAPTCHA_FAILED
- listings: карточки, которые успели собрать до ошибки
- error_state: какой детектор сработал
- error_url: URL страницы где произошла ошибка
- resume_url: URL для продолжения
- resume_page_number: номер страницы для продолжения
- continue_from(): метод для продолжения парсинга

**При ошибке неправильной страницы:**
- status: WRONG_PAGE
- error_state: какой детектор сработал (card_found / seller_profile / removed)
- error_url: URL страницы
- Продолжение невозможно — это ошибка в логике вызывающего кода

---

## Обработка капчи

Когда детектор возвращает состояние капчи (или 429, что тоже капча):

1. Вызываем `resolve_captcha_flow()` с одной попыткой.

2. После вызова состояние уже определено внутри решателя капчи.

3. Если состояние стало каталогом — продолжаем парсинг.

4. Если состояние осталось капчей — повторяем попытку.

5. Если достигнут лимит попыток (по умолчанию 30, можно передать другое значение) — возвращаем CAPTCHA_FAILED.

6. Если состояние стало критической ошибкой (403/407/not_detected) — возвращаем соответствующий статус.

---

## Обработка кнопки "Продолжить"

Когда детектор возвращает состояние кнопки "Продолжить" — вызываем `resolve_captcha_flow()`.

Решатель капчи сам обрабатывает кнопку внутри (вызывает `press_continue_and_detect()`).

---

## Навигация между страницами

Навигация происходит внутри `parse_catalog` (не в `parse_single_page`).

После успешного парсинга одной страницы каталога:

1. Ищем ссылку на следующую страницу через селектор пагинации.

2. Если ссылка найдена и не достигнут лимит max_pages — делаем `page.goto()` на URL следующей страницы.

3. Таймаут загрузки — 3 минуты (180 секунд).

4. При таймауте — retry до 5 попыток (параметр load_retries).

5. Если все retry исчерпаны — возвращаем LOAD_TIMEOUT с информацией для продолжения.

6. После успешного перехода — вызываем `parse_single_page` для новой страницы (там будет detect).

---

## Лимит страниц (max_pages)

- Передаётся при первом вызове `parse_catalog`.

- Счётчик обработанных страниц сохраняется между вызовами `continue_from()`.

- Пример: max_pages=10, обработали 5 страниц, произошла ошибка, продолжили — осталось обработать ещё 5.

- Когда счётчик достигает лимита — возвращаем SUCCESS, даже если есть ещё страницы.

---

## Хранение состояния для continue_from

Результат `CatalogParseResult` хранит внутри всё необходимое для продолжения:

**Публичные поля:**
- status — статус выполнения
- listings — все собранные карточки
- meta — метаинформация
- error_state, error_url — информация об ошибке
- resume_url — URL для продолжения
- resume_page_number — номер страницы для продолжения

**Внутреннее состояние (для continue_from):**
- Параметры первого вызова: catalog_url, fields, max_pages, sort, start_page, и т.д.
- Счётчик обработанных страниц
- Накопленные карточки

**Метод continue_from(new_page, skip_navigation=None):**
- Принимает новую страницу Playwright
- Параметр skip_navigation:
  - True — не делать goto (внешний код уже перешёл на нужную страницу)
  - False — делать goto на resume_url
  - None (по умолчанию) — автоопределение: если detect вернул каталог — не делать goto, иначе делать
- Возвращает новый CatalogParseResult с объединёнными данными

---

## Используемые компоненты библиотеки

### Детекторы (из `avito_library/detectors/`)

- `detect_page_state.py` — главный роутер, вызывает детекторы по приоритету
- `catalog_page_detector.py` — определяет страницу каталога
- `captcha_geetest_detector.py` — определяет капчу Geetest
- `proxy_block_403_detector.py` — определяет блокировку 403
- `proxy_block_429_detector.py` — определяет rate-limit 429
- `proxy_auth_407_detector.py` — определяет проблему с авторизацией прокси
- `continue_button_detector.py` — определяет кнопку "Продолжить"
- `card_found_detector.py` — определяет карточку товара
- `seller_profile_detector.py` — определяет профиль продавца
- `removed_or_not_found_detector.py` — определяет удалённое объявление

### Решатель капчи (из `avito_library/capcha/`)

- `resolver.py` — функция `resolve_captcha_flow()` для решения капчи

### Вспомогательные функции (из текущего `catalog_parser/`)

- `helpers.py` — `load_catalog_cards()`, `extract_listing()`, `get_next_page_url()`
- `models.py` — `CatalogListing`, `CatalogParseMeta` (нужно расширить)

---

## Отличия от текущей реализации

### Убираем

- Двойной goto на первую страницу
- Глобальный `_EXCHANGE` синглтон в `steam.py`
- Функции `wait_for_page_request()` и `supply_page()`
- Вызов `press_continue_and_detect()` на каждой странице (используем только `detect_page_state()`)
- Мёртвый код с дублирующими проверками состояний
- Файл `steam.py` полностью (сделать бэкап перед удалением)

### Добавляем

- Две функции: `parse_single_page` и `parse_catalog`
- Два типа результатов: `SinglePageResult` и `CatalogParseResult`
- Объект результата с методом `continue_from()`
- Хранение состояния парсера внутри объекта результата
- Явные статусы для разных типов ошибок
- Параметр `skip_navigation` с автоопределением
- Параметр `max_captcha_attempts` для настройки лимита попыток капчи
- Параметр `load_timeout` (3 минуты по умолчанию)
- Параметр `load_retries` (5 попыток по умолчанию)

### Сохраняем

- Логику парсинга карточек (`load_catalog_cards`, `extract_listing`)
- Логику навигации (`get_next_page_url`)
- Модель данных `CatalogListing`
- Интеграцию с решателем капчи

---

## Файловая структура

Создаём новый файл для реализации (старые файлы сохраняем как бэкап):

- `catalog_parser_v2.py` — новая реализация с `parse_single_page` и `parse_catalog`
- `steam.py` → `steam.py.bak` — бэкап старого оркестратора (потом удалить)
- `models.py` — расширить новыми типами (`SinglePageResult`, обновить `CatalogParseResult`)

---

## Статусы (CatalogParseStatus)

Набор статусов для обеих функций:

**Успех:**
- SUCCESS — всё обработано
- EMPTY — каталог пустой (нет карточек)

**Критические ошибки (нужна новая страница):**
- PROXY_BLOCKED — HTTP 403, IP заблокирован
- PROXY_AUTH_REQUIRED — HTTP 407, проблема с авторизацией прокси
- PAGE_NOT_DETECTED — ни один детектор не сработал
- LOAD_TIMEOUT — таймаут загрузки (после всех retry)
- CAPTCHA_FAILED — капча не решена после всех попыток

**Ошибки (неправильная страница):**
- WRONG_PAGE — страница не является каталогом (карточка/профиль/удалённое)
